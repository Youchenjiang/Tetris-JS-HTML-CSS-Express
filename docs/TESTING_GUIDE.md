# 🧪 重構後測試運行指南

## 📋 測試前準備

### 1. 確認環境

```powershell
# 檢查 Node.js 版本
node --version  # 應該 >= 14.x

# 檢查 npm 版本
npm --version
```

### 2. 確認依賴已安裝

```powershell
npm install
```

### 3. 關閉所有佔用端口的程序

```powershell
# 檢查端口佔用情況
netstat -ano | findstr ":8800"  # 遊戲服務器端口
netstat -ano | findstr ":3500"  # 客戶端服務器端口

# 如果有程序佔用,找到 PID 並關閉
taskkill /F /PID <PID>
```

## 🚀 啟動應用

### 方法 1: 使用預設端口 (推薦)

```powershell
# 確保端口 8800 和 3500 未被佔用
npm start
```

### 方法 2: 使用自定義端口

```powershell
# PowerShell
$env:REACT_APP_SERVER_PORT="8801"
$env:REACT_APP_CLIENT_PORT="3501"
node index.js

# CMD
set REACT_APP_SERVER_PORT=8801
set REACT_APP_CLIENT_PORT=3501
node index.js
```

### 方法 3: 使用 .env 文件

創建 `.env` 文件:

```env
REACT_APP_SERVER_PORT=8800
REACT_APP_CLIENT_PORT=3500
REACT_APP_SERVER_HOST=localhost
```

然後啟動:

```powershell
npm start
```

## ✅ 測試檢查清單

### 📡 服務器啟動測試

- [ ] **遊戲服務器啟動成功**

  - 看到 "✅ 遊戲服務器啟動成功"
  - 顯示地址: `http://localhost:8800`
  - 顯示最大玩家數

- [ ] **客戶端服務器啟動成功**
  - 看到 "✅ 客戶端服務器啟動成功"
  - 顯示地址: `http://localhost:3500`
  - 顯示瀏覽器訪問提示

**預期輸出**:

```
============================================================
🎮  多人俄羅斯方塊遊戲服務器
============================================================

✅ 遊戲服務器啟動成功
   地址: http://localhost:8800
   最大玩家數: 4
✅ 客戶端服務器啟動成功
   地址: http://localhost:3500

============================================================
🚀 請在瀏覽器中打開: http://localhost:3500
============================================================
```

### 🌐 瀏覽器訪問測試

- [ ] **打開遊戲頁面**

  - 在瀏覽器中訪問 `http://localhost:3500`
  - 頁面正常顯示
  - 沒有 console 錯誤

- [ ] **檢查靜態文件加載**
  - CSS 樣式正確應用
  - JavaScript 模組正確加載
  - Socket.IO 連接成功

### 👤 單人測試

- [ ] **玩家註冊**
  - 輸入玩家名稱
  - 點擊 "加入遊戲"
  - 看到成功訊息: "成功加入遊戲！"
  - 遊戲板顯示正常

**服務器日誌應顯示**:

```
🔌 新連接：Socket ID xxx
建立新玩家：Player1 (TEAM1) - Socket ID: xxx
✅ 玩家加入成功：Player1 (TEAM1)
目前玩家數：1/4
```

- [ ] **玩家準備**

  - 點擊 "準備"
  - 狀態更新為 READY

- [ ] **單人無法開始遊戲**
  - 點擊 "開始遊戲"
  - 應該看到錯誤訊息: "需要 2-4 個玩家才能開始遊戲"

### 👥 多人測試 (重要!)

**開啟 2-4 個瀏覽器視窗或分頁**

#### 玩家加入測試

- [ ] **第二個玩家加入**
  - 開啟新瀏覽器視窗/分頁
  - 訪問 `http://localhost:3500`
  - 輸入不同的玩家名稱
  - 成功加入
  - 兩個視窗都能看到玩家列表更新

**服務器日誌應顯示**:

```
🔌 新連接：Socket ID yyy
建立新玩家：Player2 (TEAM2) - Socket ID: yyy
✅ 玩家加入成功：Player2 (TEAM2)
目前玩家數：2/4
```

- [ ] **第三個玩家加入** (可選)

  - 重複上述步驟
  - 驗證 TEAM3 分配正確

- [ ] **第四個玩家加入** (可選)

  - 重複上述步驟
  - 驗證 TEAM4 分配正確

- [ ] **超過最大玩家數測試**
  - 如果已有 4 個玩家,第 5 個玩家應該無法加入
  - 應該看到錯誤訊息: "房間已滿！"

#### 遊戲開始測試

- [ ] **所有玩家準備**

  - 所有玩家點擊 "準備"
  - 驗證所有玩家狀態更新

- [ ] **開始遊戲**
  - 任一玩家點擊 "開始遊戲"
  - 所有視窗同時開始遊戲
  - 方塊開始自動下落

**服務器日誌應顯示**:

```
🎮 遊戲開始！玩家數：2/4
```

### 🎮 遊戲操作測試

在每個玩家視窗中測試以下操作:

- [ ] **方塊移動**

  - ⬅️ 左移: A 或 ← 鍵
  - ➡️ 右移: D 或 → 鍵
  - ⬇️ 下移: S 或 ↓ 鍵

- [ ] **方塊旋轉**

  - 🔄 旋轉: W 或 ↑ 鍵

- [ ] **快速下落**

  - ⚡ 瞬間下落: 空白鍵

- [ ] **消除行**
  - 填滿一行後自動消除
  - 分數增加
  - 等級提升

### 👁️ 實時同步測試

- [ ] **多玩家遊戲板同步**

  - 每個玩家可以看到所有玩家的遊戲板
  - 方塊移動即時更新
  - 分數即時更新

- [ ] **玩家淘汰**
  - 當玩家方塊堆到頂部時被淘汰
  - 看到淘汰訊息
  - 該玩家遊戲板顯示 "已淘汰"

**服務器日誌應顯示**:

```
💀 玩家 Player1 被淘汰！最終得分：1500
```

- [ ] **遊戲結束**
  - 當所有玩家被淘汰時
  - 顯示最終排名
  - 顯示各玩家得分

**服務器日誌應顯示**:

```
🏁 遊戲結束！所有玩家都被淘汰了
```

### 🔌 斷線重連測試

- [ ] **玩家中途離開**
  - 關閉一個玩家的瀏覽器視窗
  - 其他玩家看到離開通知
  - 遊戲繼續進行

**服務器日誌應顯示**:

```
👋 玩家離開：Player1 (TEAM1)
目前玩家數：1/4
```

- [ ] **遊戲中斷線**
  - 在遊戲進行中關閉視窗
  - 驗證其他玩家不受影響

## 🐛 常見問題排查

### 問題 1: 端口被佔用

**症狀**:

```
❌ 錯誤：遊戲服務器端口 8800 已被占用！
```

**解決方法**:

```powershell
# 1. 找出佔用端口的程序
netstat -ano | findstr ":8800"

# 2. 關閉該程序
taskkill /F /PID <PID>

# 3. 或使用不同端口
$env:REACT_APP_SERVER_PORT="8801"
node index.js
```

### 問題 2: 模組未找到

**症狀**:

```
Error: Cannot find module './server/config'
```

**解決方法**:

```powershell
# 檢查 server 目錄是否存在
dir server

# 檢查文件是否存在
dir server\*.js

# 如果文件不存在,需要重新創建模組
```

### 問題 3: Socket 連接失敗

**症狀**:

- 瀏覽器 console 顯示 "Socket connection failed"
- 無法加入遊戲

**解決方法**:

```powershell
# 1. 確認遊戲服務器正在運行
# 2. 檢查防火牆設置
# 3. 確認瀏覽器沒有阻擋 WebSocket 連接
# 4. 清除瀏覽器緩存並重新加載
```

### 問題 4: 前端模組加載失敗

**症狀**:

- 瀏覽器 console 顯示 404 錯誤
- "Failed to load module script"

**解決方法**:

```powershell
# 1. 檢查 public/js 目錄結構
dir public\js

# 2. 確認 index.html 中的 script 標籤
#    應該是: <script type="module" src="js/main.js"></script>

# 3. 檢查瀏覽器是否支援 ES6 模組
#    (需要現代瀏覽器: Chrome 61+, Firefox 60+, Safari 11+)
```

## 📊 成功標準

### ✅ 所有測試通過

- ✅ 服務器啟動無錯誤
- ✅ 2-4 個玩家可以同時遊戲
- ✅ 所有遊戲操作正常
- ✅ 實時同步工作正常
- ✅ 玩家淘汰和遊戲結束邏輯正確
- ✅ 斷線重連處理正常

### 🎯 性能指標

- ⚡ 頁面載入時間 < 2 秒
- ⚡ Socket 響應延遲 < 100ms
- ⚡ 遊戲幀率穩定 (每 20ms 更新)
- ⚡ 無記憶體洩漏

## 📝 測試記錄模板

```
測試日期: 2025/10/02
測試人員: _________
Node.js 版本: _________

| 測試項目 | 結果 | 備註 |
|---------|------|------|
| 服務器啟動 | ✅ / ❌ |  |
| 單人加入 | ✅ / ❌ |  |
| 多人加入 (2人) | ✅ / ❌ |  |
| 多人加入 (3-4人) | ✅ / ❌ |  |
| 遊戲開始 | ✅ / ❌ |  |
| 方塊移動 | ✅ / ❌ |  |
| 方塊旋轉 | ✅ / ❌ |  |
| 快速下落 | ✅ / ❌ |  |
| 消除行 | ✅ / ❌ |  |
| 實時同步 | ✅ / ❌ |  |
| 玩家淘汰 | ✅ / ❌ |  |
| 遊戲結束 | ✅ / ❌ |  |
| 斷線處理 | ✅ / ❌ |  |

總體評價: _________
```

## 🎉 測試完成後

如果所有測試通過:

1. ✅ 提交代碼到 Git

```powershell
git add .
git commit -m "♻️ 重構: 將 index.js 模組化,使用新的 server 模組結構"
```

2. ✅ 更新文檔
3. ✅ 標記版本

```powershell
git tag v2.0.0
```

## 💡 下一步建議

- 添加單元測試 (Jest)
- 添加集成測試 (Supertest)
- 添加性能測試
- 考慮 CI/CD 流程

---

**祝測試順利!** 🚀
